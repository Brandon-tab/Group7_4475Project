```{r}
require(tidyverse)
require(data.table)
require(randomForest)
require(mclust)
require(rpart)
require(rpart.plot)
require(foreign)
require(e1071)
```
Selection
#Data Source
#https://www.kaggle.com/datasets/whenamancodes/credit-card-customers-prediction

Pre-processing
```{r}
require(stringr)
require(sqldf)

data <- read.csv('BankChurners.csv')

missing_data<-is.na(data)

missing_df<-as.data.frame(missing_data)

missing_df

```

Excellent: 0-10% utilization
Good: 10-30% utilization
Fair: 30-50% utilization
Poor: 50% or higher utilization
Transformation
```{r}
Transform <- data

Transform$Util_Rank<-sapply(Transform$Avg_Utilization_Ratio,function(x){
 if (x <0.1 ){
   return('Excellent')
 }else if (x<0.3){
   return('Good')
 }else if (x<0.5){
   return('Fair')
 }else{
   return('Poor')
 }  
})


column_to_move <- "Util_Rank" 
target_column <- "Avg_Utilization_Ratio" 


target_position <- match(target_column, names(Transform)) + 1  


new_order <- c(names(Transform)[1:(target_position - 1)], 
               column_to_move, 
               names(Transform)[target_position:length(names(Transform))])


Transform <- Transform[, new_order]
Transform$Util_Rank.1<-NULL
Transform

```

Descriptive Analysis
Question1 - Basic Aggregration
```{r}
#Summarise the average credit limit by different card type
Credit_Average<-tapply(Transform$Credit_Limit, Transform$Card_Category, mean)
Credit_Average_df<-as.data.frame(Credit_Average)
Credit_Average_df

#count the number of different education level

Education_Count<-tapply(Transform$Education_Level, Transform$Education_Level, length)
Education_Count_df<-as.data.frame(Education_Count)
Education_Count_df

#Summaries Average of Open to buy all Income Category

Open_to_buy_Average<-tapply(Transform$Avg_Open_To_Buy, Transform$Income_Category, mean)
Open_to_buy_Average_df<-as.data.frame(Open_to_buy_Average)
Open_to_buy_Average_df
```

Question2 - Basic statics (Bar)
```{r}
ordered_indices <- order(Open_to_buy_Average_df$Open_to_buy_Average, decreasing = TRUE)
ordered_values <- Open_to_buy_Average_df$Open_to_buy_Average[ordered_indices]
ordered_names <- rownames(Open_to_buy_Average_df)[ordered_indices]

barplot(ordered_values,
        names.arg = ordered_names,
        ylim = c(500, max(ordered_values) + 100), 
        cex.names = 0.8
       )



```

Question3 - Basic statics (pie)
```{r}
Education_Count_copy<-Education_Count_df
Education_Count_copy
percentages <- round(Education_Count_copy$Education_Count / sum(Education_Count_copy$Education_Count) * 100, 1)
percent_df <- data.frame(
    Education = rownames(Education_Count_df),
    Count = Education_Count_copy$Education_Count,
    Percentage = paste(percentages, "%")
)
percent_df <- percent_df[order(-percent_df$Count), ]  
percent_df

pie(Education_Count_copy$Education_Count,
    labels = rownames(Education_Count_df),
   )

```

Question4 - Relation(scatter)
```{r}
Transform_copy <- Transform
Transform_copy
plot( Transform_copy$Total_Trans_Amt,Transform_copy$Total_Trans_Ct,
     xlab = "Transform$Total_Trans_Amt", 
     ylab = "Transform$Total_Trans_Ct"

     )
# Add x-axis ticks (interval of 5000)
axis(1, at = seq(0, max(Transform_copy$Total_Trans_Amt), by = 5000))

# Add y-axis ticks (interval of 20) 
axis(2, at = seq(0, max(Transform_copy$Total_Trans_Ct), by = 20))

# Calculate linear regression model
lm_model <- lm(Total_Trans_Ct ~ Total_Trans_Amt, data = Transform_copy)

# Add red regression line
abline(lm_model, col = "red", lwd = 2)



```

https://www.digitalocean.com/community/tutorials/normalize-data-in-r
https://stats.stackexchange.com/questions/298507/mclust-model-names-corresponding-to-common-models-i-e-those-used-for-lpa-lc
Modelname EEE = Equal variances and equal covariances
if you want to make the clustering like a matrix, try to use modelname EEE
Question5 - Clustering
```{r}
require(mclust)
require(ggplot2)
set.seed(13)  

Clustering_Transform <- Transform$Card_Category
data <- data.frame(Card_Category = Clustering_Transform,
                   Total_Trans_Ct = Transform$Total_Trans_Ct, 
                   Customer_Age = Transform$Customer_Age)

# Data preprocessing: removing missing values
data <- na.omit(data)

# Standardize data
data_scaled <- scale(data[, c("Total_Trans_Ct", "Customer_Age")])
# Use Mclust for clustering, G = 1:4, model name is EEE
model <- Mclust(data_scaled, G = 1:4, modelNames = "EEE")
summary(model)

# Add cluster labels to the data frame
data$cluster <- factor(model$classification)


ggplot(data, aes(x = Total_Trans_Ct, y = Customer_Age, color = cluster)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = median(data$Customer_Age), linetype = "dashed", color = "black") +  # middle
  geom_vline(xintercept = median(data$Total_Trans_Ct), linetype = "dashed", color = "black") +  
  labs(title = "Clustering", 
       x = "Total_Trans_Ct", 
       y = "Customer_Age", 
       color = "Cluster") +
  theme_minimal() +
  theme(legend.position = "top")+
   scale_x_continuous(breaks = seq(min(data$Total_Trans_Ct), max(data$Total_Trans_Ct), by = 20))



```

Question6 - pattern finding(CART tree)
```{r}
require(rpart)
require(rpart.plot)

treeData <- Transform

data_clean <- treeData[, c("Total_Revolving_Bal", "Util_Rank", "Income_Category","Avg_Utilization_Ratio")]


set.seed(38) 


index <- sample(1:nrow(data_clean), 0.7 * nrow(data_clean))  
train_data <- data_clean[index, ]
test_data <- data_clean[-index, ]


Tree <- rpart(Util_Rank~Total_Revolving_Bal+Income_Category,data = train_data)


rpart.plot(Tree, 
           fallen.leaves = TRUE,      
           main = "Decision Tree for Credit Utilization Behavior",
           box.palette = "RdYlGn",   
           shadow.col = "gray",       
           digits = 2)                             
```

Question7 - classification(Naive Bias)
```{r}
#new customers
new_custom <- read.csv("new_custom.csv")
new_customer <- read.csv("new_customer.csv")
#NB Classification
model <- naiveBayes(Util_Rank ~ Customer_Age
                    +Gender
                    +Dependent_count
                    +Education_Level
                    +Marital_Status
                    +Income_Category
                    +Months_on_book
                    +Total_Relationship_Count, data = Transform)
#make an enquiry
predict(model, new_custom)
predict(model, new_customer)

new_predictions <- predict(model, new_custom)
new_custom$Predicted_Utilization <- new_predictions
formatted_results <- table(new_custom$Predicted_Utilization)
formatted_results

new_predictions2 <- predict(model, new_customer)
new_customer$Predicted_Utilization <- new_predictions2
formatted_results <- table(new_customer$Predicted_Utilization)
formatted_results
```

Question8 - Prediction/simulation (random Forest)
```{r}
require(randomForest)
require(ggplot2)

#model building
model <- randomForest(formula=Credit_Limit ~ Customer_Age
                      +Gender
                      +Dependent_count
                      +Education_Level
                      +Marital_Status
                      +Income_Category
                      +Months_on_book
                      +Total_Relationship_Count, data = Transform,ntree=1000)

#model testing
plot(model)
#new customer


#choose one row data for testing
print("-----------------------------------new_custom------------------------------------")
predict(model, new_custom)
print("-----------------------------------new_customer----------------------------------")
predict(model, new_customer)
```

Evualtion
#Write you finding in Report, Thanks!
